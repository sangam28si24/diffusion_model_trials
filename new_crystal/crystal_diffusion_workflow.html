<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crystal Diffusion Model</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;0,700;1,400&family=JetBrains+Mono:wght@300;400;600&family=Libre+Franklin:wght@300;400;600;700&display=swap');

  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #21262d;
    --border: #30363d;
    --text: #e6edf3;
    --muted: #8b949e;
    --accent: #58a6ff;

    --data-col:     #2ea043;
    --data-bg:      rgba(46,160,67,0.12);
    --data-border:  rgba(46,160,67,0.5);

    --physics-col:  #f78166;
    --physics-bg:   rgba(247,129,102,0.12);
    --physics-border: rgba(247,129,102,0.5);

    --schedule-col: #bc8cff;
    --schedule-bg:  rgba(188,140,255,0.12);
    --schedule-border: rgba(188,140,255,0.5);

    --forward-col:  #e3b341;
    --forward-bg:   rgba(227,179,65,0.12);
    --forward-border: rgba(227,179,65,0.5);

    --nn-col:       #58a6ff;
    --nn-bg:        rgba(88,166,255,0.12);
    --nn-border:    rgba(88,166,255,0.5);

    --train-col:    #79c0ff;
    --train-bg:     rgba(121,192,255,0.12);
    --train-border: rgba(121,192,255,0.5);

    --reverse-col:  #ffa657;
    --reverse-bg:   rgba(255,166,87,0.12);
    --reverse-border: rgba(255,166,87,0.5);

    --valid-col:    #56d364;
    --valid-bg:     rgba(86,211,100,0.12);
    --valid-border: rgba(86,211,100,0.5);

    --out-col:      #d2a8ff;
    --out-bg:       rgba(210,168,255,0.12);
    --out-border:   rgba(210,168,255,0.5);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Libre Franklin', sans-serif;
    font-size: 14px;
    line-height: 1.6;
    padding: 40px 30px 80px;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    text-align: center;
    margin-bottom: 50px;
    padding-bottom: 30px;
    border-bottom: 1px solid var(--border);
  }
  .header h1 {
    font-family: 'Crimson Pro', serif;
    font-size: 2.6rem;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.02em;
    margin-bottom: 8px;
  }
  .header h1 span { color: var(--accent); }
  .header p {
    color: var(--muted);
    font-size: 0.95rem;
    max-width: 700px;
    margin: 0 auto;
  }

  /* ‚îÄ‚îÄ LEGEND ‚îÄ‚îÄ */
  .legend {
    display: flex; flex-wrap: wrap; gap: 10px;
    justify-content: center;
    margin-bottom: 50px;
  }
  .legend-item {
    display: flex; align-items: center; gap: 7px;
    padding: 5px 12px;
    border-radius: 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    font-size: 0.78rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

  /* ‚îÄ‚îÄ PIPELINE CONTAINER ‚îÄ‚îÄ */
  .pipeline {
    max-width: 1100px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
  }

  /* ‚îÄ‚îÄ PHASE LABELS ‚îÄ‚îÄ */
  .phase-row {
    width: 100%;
    display: flex;
    align-items: flex-start;
    gap: 20px;
    margin-bottom: 8px;
    position: relative;
  }

  .phase-label {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    padding: 12px 8px;
    border-radius: 8px;
    white-space: nowrap;
    align-self: stretch;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 34px;
  }

  .phase-content { flex: 1; }

  /* ‚îÄ‚îÄ STEP CARD ‚îÄ‚îÄ */
  .step {
    border-radius: 12px;
    border: 1px solid;
    padding: 0;
    overflow: hidden;
    margin-bottom: 4px;
    transition: box-shadow 0.2s;
  }
  .step:hover { box-shadow: 0 0 0 2px var(--accent); }

  .step-header {
    padding: 14px 20px 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    user-select: none;
  }
  .step-header:hover { filter: brightness(1.1); }

  .step-num {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 6px;
    background: rgba(255,255,255,0.1);
    letter-spacing: 0.05em;
    white-space: nowrap;
  }

  .step-title {
    font-size: 1rem;
    font-weight: 700;
    flex: 1;
  }
  .step-subtitle {
    font-size: 0.78rem;
    color: rgba(255,255,255,0.6);
    font-style: italic;
  }

  .chevron {
    transition: transform 0.25s;
    opacity: 0.5;
    font-size: 0.8rem;
  }
  .step.open .chevron { transform: rotate(180deg); }

  .step-body {
    display: none;
    padding: 0 20px 20px;
    border-top: 1px solid rgba(255,255,255,0.07);
    margin-top: 0;
  }
  .step.open .step-body { display: block; }

  /* ‚îÄ‚îÄ BODY CONTENT LAYOUT ‚îÄ‚îÄ */
  .body-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-top: 16px;
  }
  @media (max-width: 700px) { .body-grid { grid-template-columns: 1fr; } }

  .body-section { }
  .body-section h4 {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 8px;
    opacity: 0.6;
    padding-bottom: 4px;
    border-bottom: 1px solid rgba(255,255,255,0.07);
  }

  .body-section p, .body-section li {
    font-size: 0.88rem;
    color: rgba(230,237,243,0.9);
    line-height: 1.7;
    margin-bottom: 4px;
  }
  .body-section ul { padding-left: 18px; }

  /* ‚îÄ‚îÄ MATH BOXES ‚îÄ‚îÄ */
  .math-box {
    background: rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 12px 16px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.82rem;
    line-height: 1.9;
    white-space: pre;
    overflow-x: auto;
    margin-top: 6px;
    color: #cdd9e5;
  }
  .math-box .var { color: #79c0ff; }
  .math-box .op  { color: #e3b341; }
  .math-box .comment { color: #6e7681; font-style: italic; }
  .math-box .result { color: #56d364; }

  /* ‚îÄ‚îÄ PARAM TABLE ‚îÄ‚îÄ */
  .param-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
    font-size: 0.83rem;
  }
  .param-table th {
    text-align: left;
    padding: 6px 10px;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    border-bottom: 1px solid var(--border);
    color: var(--muted);
  }
  .param-table td {
    padding: 7px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    vertical-align: top;
  }
  .param-table tr:last-child td { border-bottom: none; }
  .param-table .pname {
    font-family: 'JetBrains Mono', monospace;
    color: #79c0ff;
    font-size: 0.78rem;
    white-space: nowrap;
  }
  .param-table .pval {
    color: #e3b341;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.78rem;
  }

  /* ‚îÄ‚îÄ INSIGHT BOXES ‚îÄ‚îÄ */
  .insight {
    border-left: 3px solid;
    padding: 10px 14px;
    border-radius: 0 8px 8px 0;
    font-size: 0.84rem;
    margin-top: 10px;
    line-height: 1.65;
  }

  /* ‚îÄ‚îÄ ARROWS ‚îÄ‚îÄ */
  .arrow-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 36px;
    position: relative;
    width: 100%;
  }
  .arrow-line {
    width: 2px;
    height: 100%;
    background: linear-gradient(to bottom, var(--border), var(--border));
    position: relative;
  }
  .arrow-line::after {
    content: '‚ñº';
    position: absolute;
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    color: var(--muted);
  }
  .arrow-label {
    position: absolute;
    left: calc(50% + 10px);
    top: 50%;
    transform: translateY(-50%);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    white-space: nowrap;
    background: var(--bg);
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid var(--border);
  }

  /* ‚îÄ‚îÄ DECISION DIAMOND ‚îÄ‚îÄ */
  .decision-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 4px 0;
    width: 100%;
    position: relative;
  }
  .decision {
    background: linear-gradient(135deg, #1a1f2e, #21262d);
    border: 2px solid var(--valid-border);
    color: var(--valid-col);
    padding: 14px 28px;
    font-weight: 700;
    font-size: 0.9rem;
    text-align: center;
    clip-path: polygon(20px 0%, calc(100% - 20px) 0%, 100% 50%, calc(100% - 20px) 100%, 20px 100%, 0% 50%);
    min-width: 340px;
  }
  .decision-branches {
    display: flex;
    justify-content: center;
    gap: 60px;
    margin-top: 4px;
    width: 100%;
  }
  .branch {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  .branch-label {
    font-size: 0.75rem;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 12px;
  }
  .branch-pass { background: rgba(86,211,100,0.2); color: var(--valid-col); border: 1px solid var(--valid-border); }
  .branch-fail { background: rgba(247,129,102,0.2); color: var(--physics-col); border: 1px solid var(--physics-border); }

  /* ‚îÄ‚îÄ MODE ANNOTATION ‚îÄ‚îÄ */
  .mode-box {
    width: 100%;
    max-width: 1100px;
    margin: 0 auto 16px;
    padding: 12px 20px;
    background: rgba(88,166,255,0.07);
    border: 1px solid rgba(88,166,255,0.25);
    border-radius: 10px;
    font-size: 0.84rem;
    color: rgba(88,166,255,0.9);
    display: flex; align-items: center; gap: 10px;
  }
  .mode-box strong { color: var(--accent); }

  /* ‚îÄ‚îÄ TENSOR TAG ‚îÄ‚îÄ */
  .tensor {
    display: inline-block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    background: rgba(121,192,255,0.15);
    color: #79c0ff;
    padding: 1px 6px;
    border-radius: 4px;
    border: 1px solid rgba(121,192,255,0.25);
    margin: 1px;
  }
  .val {
    display: inline-block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    background: rgba(227,179,65,0.15);
    color: #e3b341;
    padding: 1px 6px;
    border-radius: 4px;
    border: 1px solid rgba(227,179,65,0.25);
    margin: 1px;
  }

  /* ‚îÄ‚îÄ FULL-WIDTH SECTION ‚îÄ‚îÄ */
  .full-section {
    grid-column: 1 / -1;
  }

  /* ‚îÄ‚îÄ OUTPUTS GRID ‚îÄ‚îÄ */
  .outputs-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 10px;
  }
  .output-card {
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 0.82rem;
  }
  .output-card strong {
    display: block;
    font-size: 0.78rem;
    color: var(--out-col);
    margin-bottom: 4px;
    font-family: 'JetBrains Mono', monospace;
  }
</style>
</head>
<body>

<div class="header">
  <h1>Crystal Diffusion Model</h1>
</div>

<!-- LEGEND -->
<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:#2ea043"></div> Data Preparation</div>
  <div class="legend-item"><div class="legend-dot" style="background:#f78166"></div> Physics Constraints</div>
  <div class="legend-item"><div class="legend-dot" style="background:#bc8cff"></div> Diffusion Schedule</div>
  <div class="legend-item"><div class="legend-dot" style="background:#e3b341"></div> Forward Process</div>
  <div class="legend-item"><div class="legend-dot" style="background:#58a6ff"></div> Neural Network</div>
  <div class="legend-item"><div class="legend-dot" style="background:#79c0ff"></div> Training Loop</div>
  <div class="legend-item"><div class="legend-dot" style="background:#ffa657"></div> Reverse / Generation</div>
  <div class="legend-item"><div class="legend-dot" style="background:#56d364"></div> Validation</div>
  <div class="legend-item"><div class="legend-dot" style="background:#d2a8ff"></div> Output / Analysis</div>
</div>

<div class="pipeline">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELL 1 ‚Äî SETUP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--data-border); background:var(--data-bg); width:100%;" id="step1">
  <div class="step-header" onclick="toggle('step1')">
    <span class="step-num">CELL 1</span>
    <div>
      <div class="step-title" style="color:var(--data-col)">Environment Setup</div>
      <div class="step-subtitle">Import libraries, detect hardware, create output folder</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>What happens here</h4>
        <p>Python libraries are loaded and the <strong>compute device</strong> is detected. If a GPU (NVIDIA CUDA) is available, all calculations will run there ‚Äî up to 100√ó faster than CPU.</p>
        <ul>
          <li><code>torch</code> ‚Äî deep learning engine</li>
          <li><code>numpy</code> ‚Äî numerical arrays and linear algebra</li>
          <li><code>matplotlib</code> ‚Äî all visualisations</li>
          <li><code>torch.nn</code> ‚Äî neural network layer definitions</li>
        </ul>
      </div>
      <div class="body-section">
        <h4>Key outputs created</h4>
        <table class="param-table">
          <tr><th>Variable</th><th>Value</th><th>Purpose</th></tr>
          <tr><td class="pname">device</td><td class="pval">'cuda' or 'cpu'</td><td>Where tensors will live</td></tr>
          <tr><td class="pname">timestamp</td><td class="pval">'xxyyzz'</td><td>Unique suffix for saved files</td></tr>
          <tr><td class="pname">plt.rcParams</td><td class="pval">dpi=150</td><td>Plot resolution</td></tr>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div><div class="arrow-label">list of dicts</div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELL 2 ‚Äî DATASET
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--data-border); background:var(--data-bg); width:100%;" id="step2">
  <div class="step-header" onclick="toggle('step2')">
    <span class="step-num">CELL 2</span>
    <div>
      <div class="step-title" style="color:var(--data-col)">create_demo_dataset() ‚Üí 21 crystal structures</div>
      <div class="step-subtitle">Build training data from 3 canonical lattice types with augmentation</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>Three base crystal structures</h4>
        <table class="param-table">
          <tr><th>Type</th><th>Element</th><th>Atoms/Cell</th><th>a (√Ö)</th><th>Space Group</th></tr>
          <tr><td>FCC</td><td>Al (Z=13)</td><td class="pval">4</td><td class="pval">4.05</td><td>Fm-3m</td></tr>
          <tr><td>BCC</td><td>Fe (Z=26)</td><td class="pval">2</td><td class="pval">2.87</td><td>Im-3m</td></tr>
          <tr><td>Diamond</td><td>C (Z=6)</td><td class="pval">8</td><td class="pval">3.57</td><td>Fd-3m</td></tr>
        </table>
        <div class="insight" style="border-color:var(--data-border); background:var(--data-bg); margin-top:10px;">
          <strong>Fractional coordinates:</strong> Atom positions in [0,1]¬≥ relative to lattice vectors ‚Äî not absolute √Öngstr√∂ms. E.g. [0.25, 0.25, 0.25] = ¬º of the way along each lattice vector.
        </div>
      </div>
      <div class="body-section">
        <h4>Augmentation strategy (6 variants each)</h4>
        <p><strong>Thermal perturbation</strong> (variants 0‚Äì2):</p>
        <div class="math-box"><span class="var">pos_new</span> <span class="op">=</span> <span class="var">pos</span> <span class="op">+</span> N(0, œÉ)
œÉ = 0.02, 0.03, 0.04  <span class="comment"># increasing "temperature"</span>
<span class="var">pos_new</span> = <span class="var">pos_new</span> <span class="op">%</span> 1.0  <span class="comment"># enforce PBC</span></div>
        <p style="margin-top:10px;"><strong>Strain</strong> (variants 3‚Äì5):</p>
        <div class="math-box"><span class="var">strain</span> <span class="op">=</span> 1.0 <span class="op">+</span> Uniform(‚àí0.03, +0.03)
<span class="var">lattice_new</span> <span class="op">=</span> <span class="var">lattice</span> <span class="op">√ó</span> <span class="var">strain</span>
<span class="var">pos_new</span> <span class="op">=</span> <span class="var">pos</span> <span class="op">+</span> N(0, 0.015)</div>
        <p style="margin-top:6px; font-size:0.83rem; color:var(--muted);">3 base √ó (1 + 6 variants) = <strong>21 total structures</strong></p>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div><div class="arrow-label">Dataset ‚Üí DataLoader</div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELL 3 ‚Äî DATASET CLASS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--data-border); background:var(--data-bg); width:100%;" id="step3">
  <div class="step-header" onclick="toggle('step3')">
    <span class="step-num">CELL 3</span>
    <div>
      <div class="step-title" style="color:var(--data-col)">CrystalStructureDataset + DataLoader</div>
      <div class="step-subtitle">Pad variable-size structures to uniform tensors; serve batches to the model</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>The padding problem</h4>
        <p>Tensors in a batch must all have the same shape. But FCC has 4 atoms, BCC has 2, Diamond has 8. Solution: <strong>zero-pad everything to max_atoms=8</strong> and use a binary mask.</p>
        <div class="math-box"><span class="comment"># For an FCC structure (4 atoms):</span>
<span class="var">positions</span> shape: <span class="result">(8, 3)</span>
rows 0‚Äì3: real atom coords [x, y, z]
rows 4‚Äì7: [0.0, 0.0, 0.0]  <span class="comment"># padding</span>

<span class="var">mask</span>: <span class="result">[1, 1, 1, 1, 0, 0, 0, 0]</span>
        <span class="comment"># 1=real, 0=padding</span></div>
      </div>
      <div class="body-section">
        <h4>Batch tensor shapes (batch_size=4)</h4>
        <table class="param-table">
          <tr><th>Tensor</th><th>Shape</th><th>dtype</th><th>Meaning</th></tr>
          <tr><td class="pname">positions</td><td class="pval">(4, 8, 3)</td><td>float32</td><td>Fractional coords</td></tr>
          <tr><td class="pname">atom_types</td><td class="pval">(4, 8)</td><td>int64</td><td>Atomic number Z</td></tr>
          <tr><td class="pname">lattice</td><td class="pval">(4, 3, 3)</td><td>float32</td><td>Lattice vectors (√Ö)</td></tr>
          <tr><td class="pname">mask</td><td class="pval">(4, 8)</td><td>float32</td><td>Real=1, Pad=0</td></tr>
        </table>
        <div class="insight" style="border-color:var(--data-border); background:var(--data-bg); margin-top:10px;">
          <strong>DataLoader parameters:</strong><br>
          <span class="val">batch_size=4</span> ‚Äî 4 crystals per update<br>
          <span class="val">shuffle=True</span> ‚Äî random order each epoch<br>
          <span class="val">drop_last=True</span> ‚Äî discard partial last batch
        </div>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div><div class="arrow-label">positions (4,8,3) + lattice (4,3,3)</div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELL 4 ‚Äî PHYSICS VALIDATOR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--physics-border); background:var(--physics-bg); width:100%;" id="step4">
  <div class="step-header" onclick="toggle('step4')">
    <span class="step-num">CELL 4</span>
    <div>
      <div class="step-title" style="color:var(--physics-col)">PhysicsValidator ‚Äî Interatomic Distance Enforcement</div>
      <div class="step-subtitle">Pauli exclusion: no two atoms may be closer than 0.7 √Ö (used both on training data and generated structures)</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>check_minimum_distance() ‚Äî step by step</h4>
        <div class="math-box"><span class="comment"># Step 1 ‚Äî Frac ‚Üí Cartesian</span>
<span class="var">r_cart</span> <span class="op">=</span> <span class="var">r_frac</span> @ <span class="var">L</span>       <span class="comment"># (N,3) @ (3,3)</span>

<span class="comment"># Step 2 ‚Äî Displacement vector</span>
<span class="var">Œîr</span> <span class="op">=</span> <span class="var">r_i</span> <span class="op">-</span> <span class="var">r_j</span>

<span class="comment"># Step 3 ‚Äî Minimum Image Convention (PBC)</span>
<span class="var">Œîf</span> <span class="op">=</span> <span class="var">Œîr</span> @ inv(<span class="var">L</span><sup>T</sup>)      <span class="comment"># back to fractional</span>
<span class="var">Œîf'</span> <span class="op">=</span> <span class="var">Œîf</span> <span class="op">-</span> round(<span class="var">Œîf</span>)  <span class="comment"># wrap to [‚àí0.5, 0.5]</span>

<span class="comment"># Step 4 ‚Äî Back to Cartesian</span>
<span class="var">Œîr'</span> <span class="op">=</span> <span class="var">Œîf'</span> @ <span class="var">L</span>

<span class="comment"># Step 5 ‚Äî Euclidean distance</span>
<span class="var">d_ij</span> <span class="op">=</span> |<span class="var">Œîr'</span>|

<span class="comment"># Constraint</span>
<span class="result">PASS if ALL d_ij >= 0.7 √Ö</span></div>
      </div>
      <div class="body-section">
        <h4>Why Minimum Image Convention?</h4>
        <p>Crystals repeat infinitely. An atom near one face of the unit cell may be closer to an atom on the <em>opposite</em> face (via a periodic boundary) than to an atom on the same side. MIC always finds the true shortest distance.</p>
        <div class="insight" style="border-color:var(--physics-border); background:var(--physics-bg); margin-top:10px;">
          <strong>Physics:</strong> The 0.7 √Ö threshold reflects the sum of van der Waals radii. Violations indicate the model placed atoms in physically impossible overlapping positions.
        </div>
        <h4 style="margin-top:14px;">enforce_pbc()</h4>
        <div class="math-box"><span class="var">pos_wrapped</span> <span class="op">=</span> <span class="var">pos</span> <span class="op">%</span> 1.0
<span class="comment"># Wraps any coord outside [0,1] back in.
# Applied after every reverse diffusion step.</span></div>
        <p style="margin-top:6px; font-size:0.83rem;"><strong>Complexity:</strong> O(N¬≤) ‚Äî checks every pair of atoms.</p>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div><div class="arrow-label">schedule dict (arrays of length T=200)</div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELL 5 ‚Äî DIFFUSION SCHEDULE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--schedule-border); background:var(--schedule-bg); width:100%;" id="step5">
  <div class="step-header" onclick="toggle('step5')">
    <span class="step-num">CELL 5</span>
    <div>
      <div class="step-title" style="color:var(--schedule-col)">create_diffusion_schedule() ‚Äî The Noise Variance Recipe</div>
      <div class="step-subtitle">Pre-compute how much noise to add at each of the 200 timesteps (linear beta schedule)</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>Parameters</h4>
        <table class="param-table">
          <tr><th>Parameter</th><th>Value</th><th>Meaning</th></tr>
          <tr><td class="pname">T</td><td class="pval">200</td><td>Total diffusion steps</td></tr>
          <tr><td class="pname">beta_start</td><td class="pval">0.0001</td><td>Noise at t=1 (tiny)</td></tr>
          <tr><td class="pname">beta_end</td><td class="pval">0.02</td><td>Noise at t=T (large)</td></tr>
        </table>
        <h4 style="margin-top:12px;">Computed arrays (each length 200)</h4>
        <div class="math-box"><span class="var">betas</span>       = linspace(0.0001, 0.02, 200)
<span class="var">alphas</span>      = 1 <span class="op">-</span> <span class="var">betas</span>
<span class="var">alpha_bar</span>   = cumprod(<span class="var">alphas</span>)   <span class="comment"># ·æ±_t</span>

<span class="comment"># These two are used in the forward formula:</span>
<span class="var">sqrt_alpha_bar</span>       = sqrt(<span class="var">alpha_bar</span>)
<span class="var">sqrt_1minus_alpha_bar</span> = sqrt(1 <span class="op">-</span> <span class="var">alpha_bar</span>)

<span class="comment"># Used in reverse sampling:</span>
<span class="var">posterior_var</span> = <span class="var">betas</span> <span class="op">*</span> (1<span class="op">-</span><span class="var">alpha_bar_prev</span>) / (1<span class="op">-</span><span class="var">alpha_bar</span>)</div>
      </div>
      <div class="body-section">
        <h4>Signal vs Noise at key timesteps</h4>
        <table class="param-table">
          <tr><th>t</th><th>Signal ‚àö·æ±_t</th><th>Noise ‚àö(1‚àí·æ±_t)</th><th>Interpretation</th></tr>
          <tr><td class="pval">1</td><td class="pval">0.9999</td><td class="pval">0.010</td><td>Almost original</td></tr>
          <tr><td class="pval">51</td><td class="pval">0.936</td><td class="pval">0.353</td><td>Slightly noisy</td></tr>
          <tr><td class="pval">101</td><td class="pval">0.772</td><td class="pval">0.635</td><td>Half and half</td></tr>
          <tr><td class="pval">151</td><td class="pval">0.562</td><td class="pval">0.827</td><td>Mostly noise</td></tr>
          <tr><td class="pval">200</td><td class="pval">0.364</td><td class="pval">0.932</td><td>Pure noise</td></tr>
        </table>
        <div class="insight" style="border-color:var(--schedule-border); background:var(--schedule-bg); margin-top:10px;">
          <strong>Analogy:</strong> Think of this like progressive amorphisation. At t=1 the crystal is almost perfect; at t=200 it's the equivalent of a fully amorphous/gaseous state with no structural memory.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div><div class="arrow-label">x_t (noisy positions) + true noise Œµ</div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELL 6 ‚Äî FORWARD DIFFUSION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--forward-border); background:var(--forward-bg); width:100%;" id="step6">
  <div class="step-header" onclick="toggle('step6')">
    <span class="step-num">CELL 6</span>
    <div>
      <div class="step-title" style="color:var(--forward-col)">forward_diffusion_sample() ‚Äî The Corruption Step</div>
      <div class="step-subtitle">Jump directly to any noise level t using the closed-form formula, no sequential stepping needed</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>The key insight (closed-form)</h4>
        <p>Normally you'd need to apply noise 200 times sequentially. The mathematical trick: because each step is Gaussian, you can <em>jump directly to any timestep t</em> in one shot.</p>
        <div class="math-box"><span class="comment"># The closed-form forward formula</span>
<span class="comment"># (Ho et al., DDPM 2020)</span>

<span class="var">epsilon</span> ~ N(0, I)          <span class="comment"># random Gaussian</span>

<span class="var">signal</span> = sqrt_alpha_bar[t]     <span class="comment"># from schedule</span>
<span class="var">noise</span>  = sqrt_1minus_alpha_bar[t]

<span class="var">x_t</span> = <span class="var">signal</span> <span class="op">*</span> <span class="var">x_0</span>  <span class="op">+</span>  <span class="var">noise</span> <span class="op">*</span> <span class="var">epsilon</span>
<span class="comment">#  ‚Üë keeps structure    ‚Üë adds noise</span>

return <span class="result">x_t</span>, <span class="result">epsilon</span>   <span class="comment"># noisy struct + true noise</span></div>
      </div>
      <div class="body-section">
        <h4>Input / Output shapes</h4>
        <table class="param-table">
          <tr><th>Arg</th><th>Shape</th><th>Description</th></tr>
          <tr><td class="pname">x_0</td><td class="pval">(B, 8, 3)</td><td>Clean fractional coords</td></tr>
          <tr><td class="pname">t</td><td class="pval">(B,)</td><td>Random timestep per sample</td></tr>
          <tr><td class="pname">schedule</td><td>dict</td><td>Pre-computed arrays</td></tr>
          <tr><td class="pname">noise</td><td class="pval">(B, 8, 3)</td><td>Œµ ~ N(0,I) if not given</td></tr>
        </table>
        <table class="param-table" style="margin-top:8px;">
          <tr><th>Returns</th><th>Shape</th><th>Used for</th></tr>
          <tr><td class="pname">x_t</td><td class="pval">(B, 8, 3)</td><td>Noisy positions ‚Üí fed to NN</td></tr>
          <tr><td class="pname">epsilon</td><td class="pval">(B, 8, 3)</td><td>True noise ‚Üí training target</td></tr>
        </table>
        <div class="insight" style="border-color:var(--forward-border); background:var(--forward-bg); margin-top:10px;">
          <strong>Shape broadcast trick:</strong><br>
          <span class="tensor">schedule[t]</span> has shape (B,) but needs to multiply (B,8,3). The <code>[:, None, None]</code> adds two empty dimensions ‚Üí (B,1,1) which broadcasts automatically.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div><div class="arrow-label">x_t (4,8,3) ‚Üí predict Œµ</div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELL 7 ‚Äî NEURAL NETWORK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--nn-border); background:var(--nn-bg); width:100%;" id="step7">
  <div class="step-header" onclick="toggle('step7')">
    <span class="step-num">CELL 7</span>
    <div>
      <div class="step-title" style="color:var(--nn-col)">CrystalDenoisingNetwork ‚Äî The Learning Machine</div>
      <div class="step-subtitle">199,043-parameter MLP: takes noisy positions + timestep, predicts the added noise</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>Constructor parameters</h4>
        <table class="param-table">
          <tr><th>Parameter</th><th>Value</th><th>Effect if larger</th></tr>
          <tr><td class="pname">hidden_dim</td><td class="pval">128</td><td>More capacity, slower. Try 64/256/512</td></tr>
          <tr><td class="pname">time_embed_dim</td><td class="pval">128</td><td>Richer timestep representation</td></tr>
          <tr><td class="pname">num_layers</td><td class="pval">4</td><td>Deeper reasoning. Try 2/6/8</td></tr>
        </table>
        <h4 style="margin-top:12px;">Architecture ‚Äî 4 stages</h4>
        <div class="math-box"><span class="comment">Stage 1 ‚Äî Time Embedding</span>
  t ‚Üí SinEmbedding(128) ‚Üí Linear(128) ‚Üí GELU
    ‚Üí Linear(128) ‚Üí t_emb: (B, 128)
  reshape ‚Üí (B, 1, 128)  <span class="comment"># for atom-wise broadcast</span>

<span class="comment">Stage 2 ‚Äî Position Encoder</span>
  x_t: (B,8,3) ‚Üí Linear(3‚Üí128) ‚Üí GELU
    ‚Üí Linear(128‚Üí128) ‚Üí h: (B, 8, 128)
  h = h + t_emb   <span class="comment"># inject timestep info</span>

<span class="comment">Stage 3 ‚Äî 4 Residual Blocks</span>
  for each block:
    h = h + [Linear(128‚Üí128) ‚Üí GELU
             ‚Üí Linear(128‚Üí128)](h)

<span class="comment">Stage 4 ‚Äî Noise Decoder</span>
  h ‚Üí Linear(128‚Üí128) ‚Üí GELU ‚Üí Linear(128‚Üí3)
  noise_pred: (B, 8, 3)
  noise_pred = noise_pred <span class="op">*</span> mask[:,:,None]  <span class="comment"># zero padding</span></div>
      </div>
      <div class="body-section">
        <h4>SinusoidalPositionEmbeddings ‚Äî why needed?</h4>
        <p>The raw integer timestep (e.g., <span class="val">t=142</span>) gives the network little geometric meaning. Sinusoidal embeddings convert it into a 128-D vector with different frequencies ‚Äî like Fourier modes telling the network "how far along the diffusion process we are."</p>
        <div class="math-box">PE(t, 2i)   = sin(t / 10000^(2i/128))
PE(t, 2i+1) = cos(t / 10000^(2i/128))
<span class="comment"># Similar to Vaswani et al. (2017) "Attention Is All You Need"</span></div>
        <h4 style="margin-top:12px;">Key design concepts</h4>
        <div class="insight" style="border-color:var(--nn-border); background:var(--nn-bg);">
          <strong>Residual connection:</strong> h = h + f(h) ensures the original signal is always accessible. Prevents "vanishing gradient" ‚Äî gradients can flow directly backwards without being multiplied away through deep layers.
        </div>
        <div class="insight" style="border-color:var(--nn-border); background:var(--nn-bg); margin-top:8px;">
          <strong>GELU activation:</strong> Gaussian Error Linear Unit ‚Äî smoother than ReLU. "Gates" information based on its own magnitude using the Gaussian CDF.
        </div>
        <div class="insight" style="border-color:var(--nn-border); background:var(--nn-bg); margin-top:8px;">
          <strong>Mask multiplication:</strong> Padding positions always output zero noise ‚Äî they must not contribute to the loss.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div><div class="arrow-label">model + schedule + validator ‚Üí CrystalDiffusionModel</div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELL 8 ‚Äî COMPLETE MODEL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--nn-border); background:var(--nn-bg); width:100%;" id="step8">
  <div class="step-header" onclick="toggle('step8')">
    <span class="step-num">CELL 8</span>
    <div>
      <div class="step-title" style="color:var(--nn-col)">CrystalDiffusionModel ‚Äî Integrating All Components</div>
      <div class="step-subtitle">Master class: schedule + network + validator + AdamW optimizer + loss + sampling</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>__init__(timesteps=200, device='cpu')</h4>
        <p>Creates and wires together all components:</p>
        <div class="math-box"><span class="var">self.schedule</span>   = create_diffusion_schedule(T=200)
<span class="var">self.model</span>      = CrystalDenoisingNetwork(128, 128, 4)
<span class="var">self.validator</span>  = PhysicsValidator(min_distance=0.7)
<span class="var">self.optimizer</span>  = AdamW(lr=1e-4, weight_decay=1e-4)
<span class="comment"># AdamW: Adam + L2 regularisation on weights</span></div>
        <h4 style="margin-top:12px;">compute_loss(batch) ‚Üí scalar</h4>
        <div class="math-box"><span class="comment"># 1. Random timestep for each sample</span>
t    ~ Uniform(0, T)          <span class="comment"># shape (B,)</span>

<span class="comment"># 2. Random noise</span>
Œµ    ~ N(0, I)                <span class="comment"># shape (B,8,3)</span>

<span class="comment"># 3. Corrupt structure</span>
x_t  = forward_diffusion_sample(x_0, t, Œµ)

<span class="comment"># 4. Predict noise</span>
Œµ_pred = model(x_t, t, mask)

<span class="comment"># 5. MSE only over real atoms</span>
loss = mean((Œµ_pred<span class="op">*</span>mask - Œµ<span class="op">*</span>mask)¬≤)</div>
      </div>
      <div class="body-section">
        <h4>train_step(batch) ‚Üí float</h4>
        <div class="math-box"><span class="comment"># Full gradient update cycle:</span>
loss = compute_loss(batch)
optimizer.zero_grad()          <span class="comment"># clear old gradients</span>
loss.backward()                <span class="comment"># ‚àÇloss/‚àÇ(all weights)</span>
clip_grad_norm(max=1.0)        <span class="comment"># cap gradient magnitude</span>
optimizer.step()               <span class="comment"># Œ∏ ‚Üê Œ∏ ‚àí lr¬∑‚àáŒ∏</span>
return loss.item()</div>
        <h4 style="margin-top:12px;">sample(batch_size, max_atoms, lattice, mask)</h4>
        <div class="math-box"><span class="comment"># Start from pure noise</span>
x_T ~ N(0, I)                  <span class="comment"># shape (B,8,3)</span>

for t = T-1 down to 0:
  Œµ_pred = model(x_t, t, mask)
  Œ≤_t    = betas[t]
  ·æ±_t    = alpha_bar[t]
  Œ±_t    = 1 - Œ≤_t

  coeff  = Œ≤_t / sqrt(1 - ·æ±_t)
  Œº_Œ∏    = (1/sqrt(Œ±_t)) * (x_t - coeff*Œµ_pred)

  if t > 0:
    z      ~ N(0, I)
    œÉ_t    = sqrt(posterior_var[t])
    x_t-1  = Œº_Œ∏ + œÉ_t * z      <span class="comment"># stochastic step</span>
  else:
    x_0    = Œº_Œ∏                 <span class="comment"># final structure</span>

x_0 = enforce_pbc(x_0)   <span class="comment"># wrap to [0,1]¬≥</span>
return <span class="result">x_0</span></div>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div><div class="arrow-label">250 gradient updates over 50 epochs</div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELL 9 ‚Äî TRAINING LOOP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--train-border); background:var(--train-bg); width:100%;" id="step9">
  <div class="step-header" onclick="toggle('step9')">
    <span class="step-num">CELL 9</span>
    <div>
      <div class="step-title" style="color:var(--train-col)">Training Loop ‚Äî 50 Epochs √ó 5 Batches = 250 Updates</div>
      <div class="step-subtitle">Iteratively minimise noise-prediction MSE; loss drops from 0.57 ‚Üí 0.15 (73.8% improvement)</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>Configuration</h4>
        <table class="param-table">
          <tr><th>Key</th><th>Value</th><th>What changing it does</th></tr>
          <tr><td class="pname">epochs</td><td class="pval">50</td><td>‚Üë better quality, ‚Üë time. 200 rec. for prod.</td></tr>
          <tr><td class="pname">batch_size</td><td class="pval">4</td><td>‚Üë smoother gradients but more memory</td></tr>
          <tr><td class="pname">log_interval</td><td class="pval">10</td><td>Print progress frequency</td></tr>
        </table>
        <div class="math-box" style="margin-top:10px;"><span class="comment"># Training loop pseudo-code</span>
for epoch in range(50):          <span class="comment"># 50 full passes</span>
  for batch in dataloader:       <span class="comment"># 5 batches of 4</span>
    loss = model.train_step(batch)
    losses.append(loss)
  epoch_avg = mean(batch_losses)

<span class="comment"># 21 structures / batch_size 4 = 5 batches</span>
<span class="comment"># (1 structure dropped by drop_last=True)</span></div>
      </div>
      <div class="body-section">
        <h4>Training results from this run</h4>
        <table class="param-table">
          <tr><th>Metric</th><th>Value</th></tr>
          <tr><td>Initial loss (epoch 1)</td><td class="pval">0.5688</td></tr>
          <tr><td>Final loss (epoch 50)</td><td class="pval">0.1492</td></tr>
          <tr><td>Best loss (any epoch)</td><td class="pval">0.0999</td></tr>
          <tr><td>Total improvement</td><td class="pval">73.8%</td></tr>
          <tr><td>Total gradient updates</td><td class="pval">250</td></tr>
          <tr><td>Device</td><td class="pval">CUDA (GPU)</td></tr>
        </table>
        <div class="insight" style="border-color:var(--train-border); background:var(--train-bg); margin-top:10px;">
          üî¨ <strong>Loss interpretation:</strong><br>
          MSE on noise prediction in fractional-coordinate space. A value of 0.10 means the predicted noise is on average ‚àö0.10 ‚âà 0.32 fractional units away from the true noise ‚Äî still quite large, which explains the physics validation failures at generation time.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div><div class="arrow-label">trained weights ‚Üí generation</div></div>

<!-- MODE 2 NOTE -->
<div class="mode-box">
  <strong>Mode 2 shortcut:</strong> After training once (Cells 1‚Äì9), you can skip straight to Cell 10 repeatedly to generate multiple new structures <em>without retraining</em>. The trained weights are reused each time.
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELL 10 ‚Äî REVERSE DIFFUSION / GENERATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--reverse-border); background:var(--reverse-bg); width:100%;" id="step10">
  <div class="step-header" onclick="toggle('step10')">
    <span class="step-num">CELL 10</span>
    <div>
      <div class="step-title" style="color:var(--reverse-col)">Reverse Diffusion ‚Äî Generating a New Crystal from Noise</div>
      <div class="step-subtitle">Start from Gaussian noise; run 200 denoising steps guided by the trained network</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>The reverse process ‚Äî conceptually</h4>
        <p>At inference, we have <em>no</em> crystal. We start from pure random noise (the equivalent of a fully disordered amorphous melt at infinite temperature) and step the model backwards through 200 denoising steps, each time asking the neural network: <em>"what noise should I remove at this timestep?"</em></p>
        <div class="math-box"><span class="comment">Start: x_T ~ N(0, I)  ‚Üê pure noise</span>

for t = 199 down to 0:
  <span class="comment">a) Predict noise with neural network</span>
  Œµ_pred = NN(x_t, t, mask)

  <span class="comment">b) Compute denoised mean Œº_Œ∏</span>
  coeff  = Œ≤_t / sqrt(1 - ·æ±_t)
  Œº_Œ∏    = (1/sqrt(Œ±_t)) * (x_t - coeff*Œµ_pred)

  <span class="comment">c) Add stochastic noise (except at t=0)</span>
  if t > 0:
    z     ~ N(0, I)
    x_t-1 = Œº_Œ∏ + sqrt(posterior_var[t]) * z
  else:
    x_0   = Œº_Œ∏   <span class="comment">‚Üê final generated structure</span>

<span class="comment">Post-processing:</span>
x_0 = x_0 % 1.0  <span class="comment">‚Üê enforce periodic boundary</span></div>
      </div>
      <div class="body-section">
        <h4>Why add noise during reverse steps?</h4>
        <div class="insight" style="border-color:var(--reverse-border); background:var(--reverse-bg);">
          If you always take the most likely (mean) step, the model collapses toward a single "average" structure. Adding small noise at each reverse step maintains diversity ‚Äî each run produces a <em>different</em> valid crystal, sampling from the learned distribution of crystal structures.
        </div>
        <h4 style="margin-top:14px;">sample() arguments</h4>
        <table class="param-table">
          <tr><th>Arg</th><th>Value</th><th>Description</th></tr>
          <tr><td class="pname">batch_size</td><td class="pval">1</td><td>How many structures to generate</td></tr>
          <tr><td class="pname">max_atoms</td><td class="pval">8</td><td>Matches training data size</td></tr>
          <tr><td class="pname">lattice</td><td class="pval">(1,3,3)</td><td>Unit cell ‚Äî borrowed from training data</td></tr>
          <tr><td class="pname">mask</td><td class="pval">(1,8)</td><td>Atom slots ‚Äî borrowed from training data</td></tr>
        </table>
        <div class="insight" style="border-color:var(--reverse-border); background:var(--reverse-bg); margin-top:10px;">
          <strong>Note:</strong> The lattice and mask are currently copied from training data. A fully generative system would also learn to generate these. Generating the lattice independently is an active research area.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div><div class="arrow-label">x_0_generated (1,8,3) ‚Üí physics check</div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DECISION ‚Äî PHYSICS VALIDATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="decision-wrapper">
  <div class="decision">
    &nbsp; Physics Validation: &nbsp; min interatomic distance ‚â• 0.7 √Ö ?
  </div>
</div>
<div class="decision-branches">
  <div class="branch">
    <span class="branch-label branch-fail">‚úó FAILED (this run: 0.387 √Ö)</span>
    <div style="font-size:0.78rem; color:var(--muted); margin-top:4px;">‚Üí regenerate from Cell 10<br>or train longer</div>
  </div>
  <div class="branch">
    <span class="branch-label branch-pass">‚úì PASSED</span>
    <div style="font-size:0.78rem; color:var(--muted); margin-top:4px;">‚Üí proceed to analysis</div>
  </div>
</div>
<div class="arrow-container" style="margin-top:8px;"><div class="arrow-line"></div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELLS 11‚Äì12 ‚Äî VALIDATION & COMPARISON
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--valid-border); background:var(--valid-bg); width:100%;" id="step11">
  <div class="step-header" onclick="toggle('step11')">
    <span class="step-num">CELLS 11‚Äì12</span>
    <div>
      <div class="step-title" style="color:var(--valid-col)">Structure Validation + Quantitative Comparison</div>
      <div class="step-subtitle">Check physics constraints; compute density, RDF, coordination number; compare to training data</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>Structural metrics computed</h4>
        <div class="math-box"><span class="comment"># Volume of unit cell</span>
volume = |det(L)|              <span class="comment"># √Ö¬≥</span>

<span class="comment"># Density</span>
mass   = sum(atomic_masses[Z])  <span class="comment"># in amu</span>
rho    = mass*1.66e-27 / (volume*1e-30) / 1000  <span class="comment"># g/cm¬≥</span>

<span class="comment"># Coordination number</span>
cutoff = 3.5  <span class="comment"># √Ö  (adjustable)</span>
CN_i   = count(d_ij < cutoff for j != i)

<span class="comment"># RDF: radial distribution function</span>
g(r)   = histogram of all pairwise distances
<span class="comment"># peaks in g(r) = nearest-neighbour shells</span></div>
      </div>
      <div class="body-section">
        <h4>Results from this run</h4>
        <table class="param-table">
          <tr><th>Metric</th><th>Generated</th><th>Expected (Diamond)</th></tr>
          <tr><td>Atoms</td><td class="pval">8</td><td class="pval">8</td></tr>
          <tr><td>Density</td><td class="pval">3.551 g/cm¬≥</td><td class="pval">~3.51 g/cm¬≥</td></tr>
          <tr><td>Min distance</td><td class="pval">0.387 √Ö ‚úó</td><td class="pval">~1.54 √Ö</td></tr>
          <tr><td>Avg coordination</td><td class="pval">7.0</td><td class="pval">4 (tetrahedral)</td></tr>
        </table>
        <div class="insight" style="border-color:var(--valid-border); background:var(--valid-bg); margin-top:10px;">
          <strong>RDF interpretation:</strong> Sharp peaks in g(r) at characteristic distances (1.54 √Ö for C‚ÄìC, 2.46 √Ö for second shell in diamond) indicate crystalline order. A broad, featureless g(r) indicates amorphous/liquid-like output ‚Äî the model needs more training.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div><div class="arrow-label">loop N times for batch generation</div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELLS 13‚Äì15 ‚Äî BATCH ANALYSIS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--out-border); background:var(--out-bg); width:100%;" id="step13">
  <div class="step-header" onclick="toggle('step13')">
    <span class="step-num">CELLS 13‚Äì15</span>
    <div>
      <div class="step-title" style="color:var(--out-col)">Batch Generation & Statistical Analysis</div>
      <div class="step-subtitle">Generate N structures; collect population-level statistics; produce 12-panel visualisation</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section full-section">
        <h4>12 output visualisations</h4>
        <div class="outputs-grid">
          <div class="output-card"><strong>Plot 1: Density histogram</strong>Distribution of œÅ (g/cm¬≥) across generated structures</div>
          <div class="output-card"><strong>Plot 2: Volume histogram</strong>Distribution of unit cell volume (√Ö¬≥)</div>
          <div class="output-card"><strong>Plot 3: Coordination numbers</strong>Distribution of average neighbour counts</div>
          <div class="output-card"><strong>Plot 4: Min-distance distribution</strong>With 0.7 √Ö threshold line marked</div>
          <div class="output-card"><strong>Plot 5: Validation pie chart</strong>% PASSED vs FAILED physics check</div>
          <div class="output-card"><strong>Plots 6‚Äì9: 4 example 3D structures</strong>3D scatter of atom Cartesian positions</div>
          <div class="output-card"><strong>Plot 10: Atoms vs Density</strong>Scatter ‚Äî correlation between count and œÅ</div>
          <div class="output-card"><strong>Plot 11: Volume vs Density</strong>Coloured by valid/invalid flag</div>
          <div class="output-card"><strong>Saved as:</strong>outputs/batch_analysis_[timestamp].png</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="arrow-container"><div class="arrow-line"></div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CELL 16 ‚Äî SUMMARY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="step" style="border-color:var(--out-border); background:var(--out-bg); width:100%;" id="step16">
  <div class="step-header" onclick="toggle('step16')">
    <span class="step-num">CELL 16</span>
    <div>
      <div class="step-title" style="color:var(--out-col)">Summary Report + Computational Complexity</div>
      <div class="step-subtitle">All config, architecture, loss, generation metrics, and saved file list</div>
    </div>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="step-body">
    <div class="body-grid">
      <div class="body-section">
        <h4>Complexity analysis</h4>
        <div class="math-box"><span class="comment"># Training time complexity:</span>
O(E √ó B √ó T √ó N √ó d¬≤)
  E = 50 epochs
  B = 4 batch size
  T = 200 timesteps (random sample per step)
  N = 8 max atoms
  d = 128 hidden dimension

<span class="comment"># Sampling (generation) time complexity:</span>
O(T √ó N √ó d¬≤)   <span class="comment"># one full T-step reverse pass</span></div>
      </div>
      <div class="body-section">
        <h4>All generated output files</h4>
        <ul>
          <li><code>diffusion_schedule_analysis.png</code> ‚Äî Œ≤, ·æ± vs t plots</li>
          <li><code>forward_diffusion_process.png</code> ‚Äî structure at 5 timesteps</li>
          <li><code>training_curve.png</code> ‚Äî loss vs epoch and iteration</li>
          <li><code>reverse_diffusion_process.png</code> ‚Äî denoising visualisation</li>
          <li><code>structure_comparison.png</code> ‚Äî real vs generated side-by-side</li>
          <li><code>batch_analysis_[timestamp].png</code> ‚Äî 12-panel batch statistics</li>
        </ul>
      </div>
    </div>
  </div>
</div>

</div><!-- end .pipeline -->

<script>
function toggle(id) {
  const el = document.getElementById(id);
  el.classList.toggle('open');
}
// Open first step by default
document.getElementById('step1').classList.add('open');
</script>
</body>
</html>
